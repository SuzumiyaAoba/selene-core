# Selene Core å®Ÿè£…è¨ˆç”»

**æœ€çµ‚ç›®æ¨™**: è‡ªä½œ VM ä¸Šã§ã® Scheme (R5RS) å®Ÿè¡Œ

## ç¾åœ¨ã®çŠ¶æ…‹

### å®Œäº†æ¸ˆã¿

#### Phase 1: åŸºç›¤
- [x] å­—å¥è§£æå™¨ (lexer.mbt)
- [x] ãƒ‘ãƒ¼ã‚µ (parser.mbt)
- [x] å€¤è¡¨ç¾ã¨ç’°å¢ƒ (value.mbt, env.mbt)
- [x] åŸºæœ¬è©•ä¾¡å™¨ (eval.mbt)

#### Phase 2: ç‰¹æ®Šå½¢å¼
- [x] `if`, `lambda`, `define`, `set!`, `begin`
- [x] `quote`, `quasiquote`, `unquote`, `unquote-splicing`
- [x] `let`, `let*`, `letrec`
- [x] `cond`, `case`
- [x] `and`, `or`

#### Phase 3: çµ„ã¿è¾¼ã¿é–¢æ•°
- [x] ç®—è¡“æ¼”ç®— (`+`, `-`, `*`, `/`, `quotient`, `remainder`, `modulo`, etc.)
- [x] æ•°å­¦é–¢æ•° (`sin`, `cos`, `tan`, `sqrt`, `expt`, `log`, `exp`, etc.)
- [x] æ¯”è¼ƒæ¼”ç®— (`=`, `<`, `>`, `<=`, `>=`)
- [x] ãƒªã‚¹ãƒˆæ“ä½œ (`cons`, `car`, `cdr`, `list`, `append`, `reverse`, `length`, etc.)
- [x] cXXXr ã‚¢ã‚¯ã‚»ã‚µ (`caar`, `cadr`, `cdar`, `cddr`, etc.)
- [x] è¿°èª (`null?`, `pair?`, `list?`, `number?`, `symbol?`, `string?`, etc.)
- [x] ç­‰ä¾¡æ€§ (`eq?`, `eqv?`, `equal?`)
- [x] æ–‡å­—åˆ—æ“ä½œ (`string-length`, `string-ref`, `substring`, `string-append`, etc.)
- [x] æ–‡å­—åˆ—æ¯”è¼ƒ (`string<?`, `string>?`, `string<=?`, `string>=?`, `string-ci=?`, etc.)
- [x] æ–‡å­—æ“ä½œ (`char?`, `char=?`, `char<?`, `char-upcase`, `char-downcase`, etc.)
- [x] ãƒ™ã‚¯ã‚¿ (`vector`, `make-vector`, `vector-ref`, `vector-set!`, `vector-length`, etc.)
- [x] å‹å¤‰æ› (`number->string`, `string->number`, `symbol->string`, `string->symbol`, etc.)
- [x] åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ (`apply`, `map`, `for-each`, `filter`, `fold-left`, `fold-right`)
- [x] ç¶™ç¶š (`call/cc`)
- [x] I/O (`display`, `newline`, `write`, `read`)
- [x] ãƒšã‚¢æ“ä½œ (`set-car!`, `set-cdr!`)

#### Phase 4: R5RS å®Œå…¨å¯¾å¿œ
- [x] `do` ãƒ«ãƒ¼ãƒ—æ§‹æ–‡
- [x] `delay` / `force` (é…å»¶è©•ä¾¡)
- [x] `dynamic-wind`
- [x] `call-with-values` / `values` (å¤šå€¤)
- [x] `syntax-rules` ãƒã‚¯ãƒ­ã‚·ã‚¹ãƒ†ãƒ 
- [x] æ•°å€¤å¡”ã®æ‹¡å¼µ (æœ‰ç†æ•°, è¤‡ç´ æ•°)
- [x] ãƒãƒ¼ãƒˆæ“ä½œ (`open-input-file`, `open-output-file`, `read-char`, `peek-char`, `write-char`, `eof-object?`, etc.)
- [x] `load` é–¢æ•°

**ãƒ†ã‚¹ãƒˆ**: 593 ä»¶ãƒ‘ã‚¹

---

## TODO

### Phase 5: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©

- [x] ä¸­é–“è¡¨ç¾ (IR) ã®è¨­è¨ˆ
- [x] AST â†’ IR å¤‰æ›
- [x] IR ã®æœ€é©åŒ–
  - [x] å®šæ•°ç•³ã¿è¾¼ã¿
  - [x] ä¸è¦ã‚³ãƒ¼ãƒ‰é™¤å»
  - [x] ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹
- [x] ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰å½¢å¼ã®è¨­è¨ˆ
- [x] IR â†’ ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰å¤‰æ›
- [x] IR æœ€é©åŒ– - å®šæ•°ç•³ã¿è¾¼ã¿
- [x] IR æœ€é©åŒ– - ä¸è¦ã‚³ãƒ¼ãƒ‰é™¤å»
- [x] IR æœ€é©åŒ– - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹
- [x] ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
  - [x] ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼‰
  - [x] ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼‰
  - [x] ãƒã‚¤ãƒŠãƒªå½¢å¼ï¼ˆã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼‰

### Phase 6: ä»®æƒ³ãƒã‚·ãƒ³ (VM)

- [x] VM ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
  - [x] ã‚¹ã‚¿ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ vs ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ™ãƒ¼ã‚¹
  - [x] å‘½ä»¤ã‚»ãƒƒãƒˆã®å®šç¾©
  - [x] ãƒ¡ãƒ¢ãƒªãƒ¢ãƒ‡ãƒ«
- [x] åŸºæœ¬å‘½ä»¤ã®å®Ÿè£…
  - [x] ã‚¹ã‚¿ãƒƒã‚¯æ“ä½œ (push, pop, dup)
  - [x] ç®—è¡“å‘½ä»¤
  - [x] åˆ†å²å‘½ä»¤ (jump, branch)
  - [x] é–¢æ•°å‘¼ã³å‡ºã— (call, return)
- [x] ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®ã‚µãƒãƒ¼ãƒˆ
- [x] ç¶™ç¶šã®ã‚µãƒãƒ¼ãƒˆ
- [x] ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
- [x] æœ«å°¾å‘¼ã³å‡ºã—æœ€é©åŒ–

### Phase 7: çµ±åˆã¨ãƒ„ãƒ¼ãƒ«

- [x] REPL ã® VM å¯¾å¿œ
- [x] ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®è‡ªç”±å¤‰æ•°ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆå‚ç…§ã‚­ãƒ£ãƒ—ãƒãƒ£ã€ãƒœãƒƒã‚¯ã‚¹åŒ–å¯¾å¿œï¼‰
- [x] ãƒ‡ãƒãƒƒã‚¬
- [x] ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©
- [x] ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ãƒ€ãƒ³ãƒ—ãƒ„ãƒ¼ãƒ«

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Source Code                             â”‚
â”‚                    (Scheme / R5RS)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Lexer                                 â”‚
â”‚                     (lexer.mbt)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Parser                                â”‚
â”‚                     (parser.mbt)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AST                                 â”‚
â”‚                      (value.mbt)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Tree-Walking        â”‚    â”‚        Compiler          â”‚
â”‚       Interpreter        â”‚    â”‚     (Phase 5: TODO)      â”‚
â”‚       (eval.mbt)         â”‚    â”‚                          â”‚
â”‚                          â”‚    â”‚   AST â†’ IR â†’ Bytecode    â”‚
â”‚   [Current: Working]     â”‚    â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚     Virtual Machine      â”‚
                                â”‚     (Phase 6: TODO)      â”‚
                                â”‚                          â”‚
                                â”‚   Bytecode Execution     â”‚
                                â”‚                          â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/
â”œâ”€â”€ lexer.mbt              # å­—å¥è§£æ
â”œâ”€â”€ parser.mbt             # æ§‹æ–‡è§£æ
â”œâ”€â”€ value.mbt              # å€¤è¡¨ç¾
â”œâ”€â”€ env.mbt                # ç’°å¢ƒ
â”œâ”€â”€ eval.mbt               # è©•ä¾¡å™¨ã‚³ã‚¢
â”œâ”€â”€ special_form.mbt       # ç‰¹æ®Šå½¢å¼
â”œâ”€â”€ builtin_arithmetic.mbt # ç®—è¡“æ¼”ç®—
â”œâ”€â”€ builtin_char.mbt       # æ–‡å­—æ“ä½œ
â”œâ”€â”€ builtin_control.mbt    # åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼
â”œâ”€â”€ builtin_io.mbt         # I/O
â”œâ”€â”€ builtin_list.mbt       # ãƒªã‚¹ãƒˆæ“ä½œ
â”œâ”€â”€ builtin_math.mbt       # æ•°å­¦é–¢æ•°
â”œâ”€â”€ builtin_predicate.mbt  # è¿°èª
â”œâ”€â”€ builtin_string.mbt     # æ–‡å­—åˆ—æ“ä½œ
â”œâ”€â”€ builtin_vector.mbt     # ãƒ™ã‚¯ã‚¿
â”œâ”€â”€ ffi.js.mbt             # JavaScript FFI
â”œâ”€â”€ ffi.wasm.mbt           # WASM FFI
â”œâ”€â”€ ffi.wasm-gc.mbt        # WASM-GC FFI
â”œâ”€â”€ main.mbt               # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ ir.mbt                 # ä¸­é–“è¡¨ç¾ (IR)
â”œâ”€â”€ compile.mbt            # AST â†’ IR ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©
â”œâ”€â”€ opcode.mbt             # ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰å®šç¾©
â”œâ”€â”€ codegen.mbt            # IR â†’ ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
â”œâ”€â”€ optimize.mbt           # IR æœ€é©åŒ–
â”œâ”€â”€ vm.mbt                 # ä»®æƒ³ãƒã‚·ãƒ³
â”œâ”€â”€ vm_repl.mbt            # VM REPL ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
â”œâ”€â”€ gc.mbt                 # ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
â”œâ”€â”€ debugger.mbt           # ãƒ‡ãƒãƒƒã‚¬
â”œâ”€â”€ profiler.mbt           # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©
â”œâ”€â”€ bytecode_dump.mbt      # ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ãƒ€ãƒ³ãƒ—ãƒ„ãƒ¼ãƒ«
â””â”€â”€ *_test.mbt             # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç¾¤
```

---

## æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

**Phase 4 å®Œäº†** âœ“

**Phase 5 (ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©) åŸºæœ¬å®Œäº†** âœ“
- ä¸­é–“è¡¨ç¾ (IR) ã®è¨­è¨ˆ âœ“
- AST â†’ IR å¤‰æ› âœ“
- ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰å½¢å¼ã®è¨­è¨ˆ âœ“
- IR â†’ ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰å¤‰æ› âœ“

**Phase 6 (VM) åŸºæœ¬å®Œäº†** âœ“
- ã‚¹ã‚¿ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ VM âœ“
- ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ»ç¶™ç¶šã‚µãƒãƒ¼ãƒˆ âœ“
- æœ«å°¾å‘¼ã³å‡ºã—æœ€é©åŒ– âœ“

**Phase 7 (çµ±åˆã¨ãƒ„ãƒ¼ãƒ«) å®Œäº†** âœ“
- REPL ã® VM å¯¾å¿œ âœ“
- ãƒ‡ãƒãƒƒã‚¬ âœ“
- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ© âœ“
- ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ãƒ€ãƒ³ãƒ—ãƒ„ãƒ¼ãƒ« âœ“

**ã™ã¹ã¦ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã—ã¾ã—ãŸï¼** ğŸ‰

---

## å‚è€ƒè³‡æ–™

- [R5RS ä»•æ§˜æ›¸](docs/r5rs.pdf)
- [MoonBit è¨€èªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.moonbitlang.com/docs/)
