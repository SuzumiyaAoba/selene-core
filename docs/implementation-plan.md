# R5RS 実装計画（Moonbit / selene-core）

## 参照資料
- R5RS 仕様書: `docs/r5rs.pdf`（schemers.org の公開版）

## 実装フェーズ案
1. 字句解析・リーダ
   - 空白/コメント（`;`〜改行）、数字・識別子・記号のトークナイズ
   - リテラル: 数（整数/実数/有理/複素は段階的に、`#e`/`#i` の exact/inexact 指定も含む）、文字（エスケープ含む）、文字列、ブール、シンボル、リスト/ベクタのリーダ
   - クォート系列: `'`/`` ` ``/`,`/`,@` を構文糖として AST へ展開（ドット対やベクタ内 quasiquote も処理）
   - 冒頭 shebang（`#!...`）の扱い方針を決める
2. 構文解析
   - プログラム/フォームを AST 化（`define`、`lambda`、`if`、`set!`、`begin`、`cond`、`case`、`let` 系、`do`、`delay` 等）
   - エラー報告: 不正な括弧・未終端文字列・無効トークン
3. 値表現と環境
   - 値型: 不定精度整数、実数、有理/複素（段階的）、文字列、文字、シンボル、ペア、ベクタ、手続き（ネイティブ/クロージャ）、ポート
   - 環境: フレーム連鎖 + ミューテーション（`set!`）対応、トップレベルとレキシカル環境の分離
4. 評価器
   - 正格評価の中心ループ（`eval`）と適用（`apply`）、proper tail recursion
   - 継続: `call/cc` 対応（Moonbit での表現方式を検討）と `dynamic-wind` の整合性確認
   - 遅延: `delay`/`force`（promise オブジェクト）
5. 組み込み手続き
   - 数値演算と比較（R5RS 6.2）
   - 文字列/リスト/ベクタ操作（6.3）
   - 制御: `map`/`for-each`/`apply`/`eval`/`load`、`call-with-values`/`values`
   - 同一性: `eq?`/`eqv?`/`equal?` の境界条件を仕様通りに
   - I/O: ポート、`read`/`write`/`display`/`newline`/`peek-char`/`read-char` 等
6. マクロ
   - `syntax-rules` による衛生的マクロ展開（`...` の使用制約、リテラル集合、シャドーイング）
   - 展開段階の環境とエラーメッセージの整備
7. REPL とスクリプト実行
   - 対話的 REPL（プロンプト、結果表示、エラー報告）
   - ファイル読み込みとトップレベル評価（`load`）、割り込み/EOF ハンドリング
8. テスト戦略
   - R5RS 例題に基づくゴールデンテスト
   - 各フェーズごとのユニットテスト（字句解析、パーサ、評価器、組み込み）
   - マクロ展開の差分テスト
   - 追加観点: tail-call 最適化、`call/cc` + `dynamic-wind`、`values`、ポートエラー（クローズ済み操作など）、quasiquote ネスト/ベクタ/ドット対

## 直近の着手タスク（スプリント候補）
- [ ] 字句解析器スケルトンと最小テスト（識別子/数/括弧/コメント）
- [ ] クォート展開（`'`/`` ` ``/`,`/`,@`）の AST 変換ユーティリティ
- [ ] パーサの骨組み（S 式 → AST）とエラーレポート整備
- [ ] 値型の定義ドラフト（`src/lang/value.mbt` 等）と環境構造の設計メモ
- [ ] REPL/評価器用のエントリポイント雛形（`src/repl/main.mbt` 想定）

## モジュール構成（案）
- `src/lexer/` : トークナイザとテスト
- `src/parser/` : S 式パーサ、クォート展開
- `src/lang/` : 値表現、環境、手続き、継続
- `src/eval/` : 評価器本体、組み込み登録
- `src/repl/` : 対話環境と I/O
- `tests/` : 各層のユニットテストと R5RS 互換テスト

## 懸念点メモ
- Moonbit での継続 (`call/cc`) の実装方式を事前検証する
- 数値塔（有理/複素）の段階投入と性能バランス
- I/O とポートの抽象化（REPL 用の標準入出力とファイルポート）
- 環境・トップレベルでの再定義許容範囲とロードパス運用
- エラー報告方針（未束縛識別子、型エラー、閉じたポート操作など）
- CI での R5RS 互換テストセット運用とビルド/テストコマンドの標準化
